# SoftLoop

## はじめに

このプロジェクトでは、M5Stack など、ディスプレイ表示可能なマイコンにおいて、React のような、宣言的 UI によって画面のコーディングが可能かつ、容易にルーティングが可能な言語を開発する。このプロジェクトは国立研究開発法人情報通信研究機構 Sechack365 2023 年度において開発した、SoftLoop(34Dk)の派生である。

## 背景

昨今、Web フロントエンド分野においては、React 、 Next.js や Remix.js など、コンポーネントを主体にフロントエンド・画面を開発することができるライブラリやフレームワークが次々と誕生しており、一般企業においてもその技術が広く支持されはじめていることは明白である。画面の設計・開発は、手間がかかる作業である。しかし、宣言的 UI を用いれば、コンポーネントと呼ばれる部品単位で容易に構成でき、コンポーネント単位で再利用やテストができるため、前項の手間を少し、あるいは大幅に緩和している。テストツールも playwright や storybook など、次々と登場している。現に、丸山が非正規の技術職として所属している株式会社 toridori では、フロントエンド技術として Next.js や Remix.js が使用されており、私自身も携わっている。

しかし、マイコンや、組み込みなどの分野は、その制約から、フロントエンド技術からは遠く離れているように思える。理由は明らかである。C 言語などで動いており、いかにメモリ容量を少なく、高速に、安定に動かす必要がある組み込み機器に DOM レンダリングの思想を持ち込むのは、明らかに的外れで過剰である。また、軽量であることが求められ、場合によってはアセンブリを使用することが是とされるような分野に、npm や webpack のようなビルドツールを使用するような未来はなかなか見ることが出来ない。

## 目的

そこで、本ソフトウェアでは、宣言的 UI を念頭に置いた言語とその処理系を開発する。フロントエンド技術をマイコンへ持ち込み、宣言的 UI の利点を生かした処理系を開発する。これによって、フロントエンド技術者のマイコン開発の参入をより容易にし、また宣言的 UI のマイコン分野での発展に寄与する。実行方式は中間表現となるバイトコードを用いた実行方式を採用する。バイトコードは、構文木巡回による処理系と、アセンブリレベルでの処理系のそれぞれの利点・難点を調整し、その中庸を狙う方式である。そのため、構文木巡回による処理の遅さと、アセンブリレベルでの実装の困難さ、移植の難しさのそれぞれの難点をカバーすることができる。実装には、過去に開発した構文解析表を生成・出力する文脈自由文法の処理プログラムを活用する。

## 言語仕様

現在の言語の構文規則は次のとおりである。これは文脈自由文法を表現する記法の一つである BNF にいくつかの独自記法を追加したものである。この構文規則を前述の文脈自由文法処理プログラムに入力することで、LR(1)法による決定性有限オートマトンを通した構文解析表を作成することができる。解析対象となる原始プログラムに対して、構文解析表を照らし合わせることで、その原始プログラムが構文規則に乗っ取っているか否か、および具象構文木を作成することができる。すなわち、この構文規則を編集することによって、容易に構文解析が行うことができるという事である。なお、この構文規則は、記号などの配置が曖昧である他、十分な規則ではないため、今後随時調整をする予定である。特に配列の表現は調整が必要である。

```
<S> ::= <EL>
<EL> ::= <E> \*
<E> ::= <left> ";" | <right> ";" | <left> "=" <right> ";" | <ifexpr> | <while> | <function> | <component> | <class> | <interface> | <return> ";"

<left> ::= <value_definition> | <array_definition> | <value_name> | <array_name>
<right> ::= <comparison_equal> | <function_message_passing> | <new_array>

<comparison_equal> ::= <comparison_equal> "==" <comparison> | <comparison_equal> "!=" <comparison> | <comparison>
<comparison> ::= <comparison> "<" <expr> | <comparison> "<=" <expr> | <comparison> ">" <expr> | <comparison> ">=" <expr> | <expr>

<expr> ::= <expr> "+" <term> | <expr> "-" <term> | <term>
<term> ::= <term> "\*" <factor> | <term> "/" <factor> | <term> "%" <factor> | <factor>
<factor> ::= <number> | "(" <right> ")" | <value_name> | <array_name> | <text>

<number> ::= NUM
<value_definition> ::= <type_name> <value_name>
<array_definition> ::= <type_name> <array_length> <value_name>

<type_name> ::= "int" | "string" | "void"
<value_name> ::= TEXT

<text> ::= """ TEXT """ | "'" TEXT "'" | """ NUM """ | "'" NUM "'" | """ """ | "'" "'"

<array_name> ::= <value_name> <array_length>
<array_length> ::= "[" <right> "]" <array_length> | "[" "]" <array_length> |

<new_array> ::= new <type_name> <array_length>

<ifexpr> ::= <if>
<if> ::= "if" <right> <block>
<while> ::= "while" <right> <block>
<function> ::= <value_definition> "(" <argument> ")" <block>
<function_message_passing> ::= <value_name> "(" <value_enumeration> ")"
<argument> ::= <value_definition> "," <argument> | <value_definition> |
<value_enumeration> ::= <right> "," <value_enumeration> | <right> |
<return> ::= "return" | "return" <right>

<block> ::= "{" <EL> "}"

<component> ::= "component" TEXT <block> | "component" TEXT TEXT <block>

<class> ::= "class" TEXT <block> | "class" TEXT TEXT<block>
<interface> ::= "interface" TEXT <block>
```
